{"title":"Mapd'O Network metrics exploration","markdown":{"yaml":{"title":"Mapd'O Network metrics exploration","subtitle":"Progress meeting 22.04.2024","author":"Leo Helling","title-slide-attributes":{"data-background-color":"#023e8a"}},"headingText":"load network metrics","containsRefs":false,"markdown":"\n\n```{r set-up}\n#| echo: false\n#| output: false\nlibrary(tidyverse)\nrequire(RPostgreSQL)\nrequire(DataExplorer) # general dataset exploration\nlibrary(factoextra) # for pca-biplots \nlibrary(sf) # geospatial manipulations\nlibrary(mapview) # geospatial visualisation\nsource(\"src/f_explo.R\")\nsource(\"src/f_database.R\")\n\nnetwork_metrics <- load_network_metrics()\n\n# create network sf-file\nnetwork_sf <- load_metrics_sf(network_metrics)\n\n# create datasets\ndata_all <- network_metrics|> dplyr::select(\"strahler\":\"sum_area\")\ndata_discrete <- network_metrics|> dplyr::select(\"strahler\":\"built_environment\", \"sum_area\")\ndata_relative <- network_metrics|> dplyr::select(\"fid\", \"strahler\":\"floodplain_slope\", \"water_channel_pc\":\"sum_area\")\n```\n\n## Points\n\n-   Dataset overview\n\n-   Variable cleaning\n\n-   Principal Component Analysis\n\n-   K-means Clustering\n\n-   Hidden-Markov-Modeling\n\n-   Next steps\n\n## Dataset overview\n\n::: panel-tabset\n### Map\n\n```{r map}\n#| echo: false\n# out-width: \"50%\"\n\n# plot network \nplot(network_sf |> dplyr::select())\n# mapview::mapview(network_sf |> dplyr::select(strahler))\n```\n\n### Variables\n\n```{r variable overview}\n# plot histograms for all variables\nDataExplorer::plot_histogram(data_all, nrow = 4)\n```\n\n### Correlation: real Vars\n\n```{r corr discrete}\n#| echo: false\n#| warning: false\n\nDataExplorer::plot_correlation(data_discrete, title = \"Correlation Matrix of discrete variables\")\n```\n\n### Correlation: Norm. Vars\n\n```{r corr normalized}\n#| echo: false\n#| warning: false\n\nDataExplorer::plot_correlation(data_relative |> dplyr::select(!fid), title = \"Correlation Matrix of relative variables\")\n```\n\nDataset containing only the normalized variables for the land use and lateral continuity (area normalized to the valley bottom area)\n:::\n\n## Variable cleaning\n\n::: panel-tabset\n### Description\n\nBased on high values of correlation and similarities in the PCA, the following variables are removed:\n\n-   `floodplain_slope` as it is represented well by `talweg_slope`\n-   `gravel_bars_pc` as it is represented well in `active_channel_pc`\n-   `water_channel_width` as it is represented well in `active_channel_width`\n-   `valley_bottom_width` by `sum_area`\n-   `semi_natural_pc` as it is falsely calculated and only represents `grassland_pc`\n-   `reversible_pc` as as it is falsely calculated and only represents `grassland_pc` and `crops_pc`\n-   `infrastructures_pc`, `dense_urban_pc`, and `diffuse_urban_pc` are well represented by `built_environment_pc`\n-   `natural_corridor_width` represented well by `connected_corridor_width`\n\n### Cleaned dataset\n\n```{r corr cleaned}\n#| echo: false\n#| warning: false\n\nvariables_remove <- c(\"floodplain_slope\", \"gravel_bars_pc\", \"water_channel_width\",\n                      \"valley_bottom_width\", \"semi_natural_pc\", \"infrastructures_pc\",\n                      \"dense_urban_pc\", \"diffuse_urban_pc\", \"natural_corridor_width\", \"reversible_pc\")\n\ndata_cleaned_pc <- data_relative |> dplyr::select(!variables_remove)\nDataExplorer::plot_correlation(data_cleaned_pc |> dplyr::select(!fid), title = \"Correlation Matrix of cleaned dataset\")\n```\n:::\n\n## PCA\n\n::: panel-tabset\n### cleaned dataset\n\n```{r}\n#| echo: false\n#| warning: false\n\nDataExplorer::plot_prcomp(data_cleaned_pc |> dplyr::select(!fid), variance_cap = 0.9, nrow = 2L, ncol = 2L, title = \"PCA of cleaned variables\")\n\n# Biplots generation\npca_cleaned <- prcomp(data_cleaned_pc |> dplyr::select(!fid), \n                      scale = TRUE)\n\nfactoextra::fviz_pca_ind(pca_cleaned,\n                         label = \"none\",\n                         col.ind = \"cos2\",\n                         alpha.ind = 0.7,\n                         gradient.cols = c(\"#03045e\",\"#caf0f8\",\"#d62828\"),\n                         title = \"PCA-Biplot 1-2: Quality of representation of individuals\")\n\nfactoextra::fviz_pca_var(pca_cleaned,     \n                         label = \"var\",\n                         select.var = list(contrib = 10),\n                         repel = T,\n                         title = \"PCA-Biplot 1-2: contribution of first 10 variables\")\n\nfactoextra::fviz_pca_ind(pca_cleaned,\n                         axes = c(1,3),\n                         label = \"none\",\n                         col.ind = \"cos2\",\n                         alpha.ind = 0.7,\n                         gradient.cols = c(\"#03045e\",\"#caf0f8\",\"#d62828\"),\n                         title = \"PCA-Biplot 1-3: Quality of representation of individuals\")\n\nfactoextra::fviz_pca_var(pca_cleaned,\n                         axes = c(1,3),\n                         label = \"var\",\n                         select.var = list(contrib = 10),\n                         repel = T,\n                         title = \"PCA-Biplot 1-3: contribution of first 10 variables\")\n\nfactoextra::fviz_pca_ind(pca_cleaned,\n                         axes = c(1,4),\n                         label = \"none\",\n                         col.ind = \"cos2\",\n                         alpha.ind = 0.7,\n                         gradient.cols = c(\"#03045e\",\"#caf0f8\",\"#d62828\"),\n                         title = \"PCA-Biplot 1-4: Quality of representation of individuals\")\n\nfactoextra::fviz_pca_var(pca_cleaned,\n                         axes = c(1,4),\n                         label = \"var\",\n                         select.var = list(contrib = 10),\n                         repel = T,\n                         title = \"PCA-Biplot 1-4: contribution of first 10 variables\")\n```\n\nAccording to the results, the first four principal components are sufficient to represent 64.5 % of the variability of the data set. In the following, each of these PCs is analysed according to the individual association of the variables to them in order to facilitate interpretation.\n\n+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| PC      | Description                                                                                                                                                                                         |\n+=========+=====================================================================================================================================================================================================+\n| **PC1** | ***Positive values** indicate* *large rivers in wide valleys with low slopes and low elevations, with comparably small riparian corridor and diverse anthropogenic activity in the adjacent areas.* |\n|         |                                                                                                                                                                                                     |\n|         | ***Negative values** indicate smaller rivers in narrow valleys with higher slopes and elevations, with a greater relative area for the riparian corridor and less activity in the adjacent areas.*  |\n|         |                                                                                                                                                                                                     |\n|         | -   positive variable importance: `sum_area`, `strahler`, `connected_corridor_width`, `active_channel_width`, `crops_pc`, `disconnected_pc`                                                         |\n|         |                                                                                                                                                                                                     |\n|         | -   negative variable importance:`talweg_slope`, `talweg_elevation_min`, `riparian_corridor_pc`                                                                                                     |\n+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| **PC2** | ***Positive values** indicate rather narrow valleys in which most of the space is taken by the water channel with few space for the connected corridor and crops.*                                  |\n|         |                                                                                                                                                                                                     |\n|         | ***Negative values** indicate wide valleys with smaller channel width to valley width ratios and larger shares of connected corridor and crops.*                                                    |\n|         |                                                                                                                                                                                                     |\n|         | -   positive VI: `water_channel_pc`, `idx_confinement`, `active_channel_width`                                                                                                                      |\n|         |                                                                                                                                                                                                     |\n|         | -   negative VI: `sum_area`, `crops_pc`, `disconnected_pc`, `connected_corridor_width`                                                                                                              |\n+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| **PC3** | ***Positive values** indicate comparably large and forested riparian corridors in lower elevations with few grassland and natural open area.*                                                       |\n|         |                                                                                                                                                                                                     |\n|         | ***Negative values** thus indicate comparably small and unforested riparian corridors in higher elevations and with more natural open areas and grasslands.*                                        |\n|         |                                                                                                                                                                                                     |\n|         | -   positive VI: `riparian_corridor_pc`, `forest_pc`                                                                                                                                                |\n|         |                                                                                                                                                                                                     |\n|         | -   negative VI: `talweg_elevation_min`, `natural_open_pc`, `grassland_pc`                                                                                                                          |\n+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| **PC4** | ***Positive values** indicate rather smaller, confined streams with a strong presence of anthropogenic infrastructure.*                                                                             |\n|         |                                                                                                                                                                                                     |\n|         | ***Negative values** thus indicate comparably larger rivers with more space for the active channel and no presence of built/anthropogenic infrastructure in the adjacent zones.*                    |\n|         |                                                                                                                                                                                                     |\n|         | -   positive VI: `riparian_corridor_pc`, `forest_pc`                                                                                                                                                |\n|         |                                                                                                                                                                                                     |\n|         | -   negative VI: `talweg_elevation_min`, `natural_open_pc`, `grassland_pc`, `idx_confinement`, `crops_pc`, `active_channel_width`, `connected_corridor_width`                                       |\n+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n\n: Characteristics of principal components\n\n### whole dataset\n\n```{r PCA all variables}\n#| echo: false\n#| warning: false\n\nDataExplorer::plot_prcomp(data_all, variance_cap = 0.7, nrow = 1L, ncol = 2L, title = \"PCA of discrete variables\")\n\n# Biplots generation\npca_all <- prcomp(data_all, \n                  scale = TRUE)\n\nfactoextra::fviz_pca_ind(pca_all,\n                         label = \"none\",\n                         col.ind = \"cos2\",\n                         alpha.ind = 0.7,\n                         gradient.cols = c(\"#03045e\",\"#caf0f8\",\"#d62828\"),\n                         title = \"PCA-Biplot 1-2: Quality of representation of individuals\")\n\nfactoextra::fviz_pca_var(pca_all,     \n                         label = \"var\",\n                         select.var = list(contrib = 10),\n                         repel = T,\n                         title = \"PCA-Biplot 1-2: contribution of first 10 variables\")\n```\n\n### only real vars\n\n```{r PCA discrete variables}\n#| echo: false\n#| warning: false\n\nDataExplorer::plot_prcomp(data_discrete, variance_cap = 0.9, nrow = 2L, ncol = 2L, title = \"PCA of discrete variables\")\n\n# Biplots generation\npca_dis <- prcomp(data_discrete, \n                  scale = TRUE)\n\nfactoextra::fviz_pca_ind(pca_dis,\n                         label = \"none\",\n                         col.ind = \"cos2\",\n                         alpha.ind = 0.7,\n                         gradient.cols = c(\"#03045e\",\"#caf0f8\",\"#d62828\"),\n                         title = \"PCA-Biplot 1-2: Quality of representation of individuals\")\n\nfactoextra::fviz_pca_var(pca_dis,     \n                         label = \"var\",\n                         select.var = list(contrib = 10),\n                         repel = T,\n                         title = \"PCA-Biplot 1-2: contribution of first 10 variables\")\n```\n\n### only norm. vars\n\n```{r}\n#| label: PCA relative variables\n#| echo: false\n#| warning: false\n\nDataExplorer::plot_prcomp(data_relative |> dplyr::select(!fid), variance_cap = 0.9, nrow = 2L, ncol = 2L, title = \"PCA of relative variables\")\n\n# Biplots generation\npca_rel <- prcomp(data_relative |> dplyr::select(!fid), \n                  scale = TRUE)\n\nfactoextra::fviz_pca_ind(pca_rel,\n                         label = \"none\",\n                         col.ind = \"cos2\",\n                         alpha.ind = 0.7,\n                         gradient.cols = c(\"#03045e\",\"#caf0f8\",\"#d62828\"),\n                         title = \"PCA-Biplot 1-2: Quality of representation of individuals\")\n\nfactoextra::fviz_pca_var(pca_rel,     \n                         label = \"var\",\n                         select.var = list(contrib = 10),\n                         repel = T,\n                         title = \"PCA-Biplot 1-2: contribution of first 10 variables\")\n```\n:::\n\n## K-means Clustering\n\n::: panel-tabset\n### Method\n\nK-means is a clustering method that generates clusters based on the search for centers of gravity to which the mean distance from the associated data points is minimized. In order to apply this method, the number of clusters must first be determined. For this purpose, 24 different indices were evaluated using the `NBClust`-package. Among all indices:\\\n\n-   4 proposed 2 as the best number of clusters\n-   5 proposed 3 as the best number of clusters\n-   2 proposed 4 as the best number of clusters\n-   10 proposed 5 as the best number of clusters\n-   1 proposed 8 as the best number of clusters\n-   1 proposed 9 as the best number of clusters\n-   1 proposed 10 as the best number of clusters\n\nAccording to the majority rule, the best number of clusters is 5.\n\n### Results\n\n```{r clustering}\n#| label: clustering\n#| echo: false\n#| warning: false\n\ndata_cleaned_pc$PC1 <- pca_cleaned$x[,\"PC1\"]\ndata_cleaned_pc$PC2 <- pca_cleaned$x[,\"PC2\"]\ndata_cleaned_pc$PC3 <- pca_cleaned$x[,\"PC3\"]\ndata_cleaned_pc$PC4 <- pca_cleaned$x[,\"PC4\"]\n\n\n# # automatic clustering ----------------------------------------------------\n# automatic_clustering <- function(data){\n#   library(NbClust)\n# \n#   set.seed(123)\n# \n#   data_clust <- data |>\n#     scale() |>\n#     NbClust(distance = \"euclidean\",\n#             min.nc = 2,\n#             max.nc = 10,\n#             method = \"kmeans\",\n#             index = \"all\")\n# \n#   return(data_clust)\n# }\n# \n# # apply automatic clustering to identify optimal number of clusters\n# auto_clust <- automatic_clustering(data = data_cleaned_pc |> dplyr::select(PC1:PC4))\n\n# OPTIMAL NUMBER OF CLUSTERS: 4\nno_clusters <- 5\n\n\n# Apply clusters to data --------------------------------------------------\n\n# create cluster file\ndata_clust <- eclust(data_cleaned_pc |> select(PC1:PC4),\n                     FUNcluster = \"kmeans\",\n                     k = no_clusters,\n                     graph = FALSE)\n\n\n# Assign the optimal partition to original dataset\ndata_cleaned_pc$cluster <- as.factor(data_clust$cluster)\n\n\n# show cluster plot\nfviz_cluster(data_clust,\n             axes = c(1,2),\n             palette = cols,\n             ggtheme = theme_minimal(),\n             main = \"Bi-Plot Cluster on C 1&2\",\n             geom = \"point\"\n)\n\nfviz_cluster(data_clust,\n             axes = c(1,3),\n             palette = cols,\n             ggtheme = theme_minimal(),\n             main = \"Bi-Plot Cluster on C 1&3\",\n             geom = \"point\"\n)\n\nfviz_cluster(data_clust,\n             axes = c(1,4),\n             palette = cols,\n             ggtheme = theme_minimal(),\n             main = \"Bi-Plot Cluster on C 1&4\",\n             geom = \"point\"\n)\n\n\n# recreate biplot of PC1-PC2, colored by clusters \n# pca_cleaned_grouped <- FactoMineR::PCA(data_cleaned_pc |> dplyr::select(!fid), \n#                 scale.unit = TRUE,\n#                 quali.sup = c(\"cluster\"), \n#                 graph = FALSE)\n# \n# factoextra::fviz_pca_ind(pca_cleaned_grouped,\n#                          label = \"none\",\n#                          habillage = \"cluster\",\n#                          col.ind = \"cluster\",\n#                          alpha.ind = 0.7,\n#                          palette = cols,\n#                          title = \"PCA-Biplot 1-2: Quality of representation of individuals\")\n\n```\n\n```{r boxplots clusters}\n#| label: boxplots clusters\n#| echo: false\n#| warning: false\n\nplot_jitterboxplots_pca <- function(data){\n  \n  p1 <- ggpubr::ggboxplot(data, x = \"cluster\", y = \"PC1\", add = \"jitter\", color = \"cluster\", palette = cols, ggtheme = theme_minimal()) \n  p2 <- ggpubr::ggboxplot(data, x = \"cluster\", y = \"PC2\", add = \"jitter\", color = \"cluster\", palette = cols, ggtheme = theme_minimal()) \n  p3 <- ggpubr::ggboxplot(data, x = \"cluster\", y = \"PC3\", add = \"jitter\", color = \"cluster\", palette = cols, ggtheme = theme_minimal()) \n  p4 <- ggpubr::ggboxplot(data, x = \"cluster\", y = \"PC4\", add = \"jitter\", color = \"cluster\", palette = cols, ggtheme = theme_minimal()) \n  \n  plot <- ggpubr::ggarrange(p1, p2, p3, p4, ncol=2, nrow=2, legend=\"none\")\n  \n  return(plot)\n}\n\nplot_jitterboxplots_pca(data_cleaned_pc |> dplyr::filter(fid <= 9041 & fid >=7623))\n\n```\n\n### Cluster characteristics\n\nBased on the data-distributions, the main characteristics of the clusters are summarized in the following table:\n\n+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Cluster  | Derived characteristics                                                                                                                                 |\n+==========+=========================================================================================================================================================+\n| **1**    | **Rivers confined by anthropogenized floodplain**                                                                                                       |\n|          |                                                                                                                                                         |\n|          | Rather confined, lower elevation rivers with altered riparian zone including diverse usages such as urban and agricultural infrastructure.              |\n|          |                                                                                                                                                         |\n|          | -   above average values: `PC4`, `PC1`                                                                                                                  |\n+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------+\n| **2**    | **Larger rivers with agricultural landscape**                                                                                                           |\n|          |                                                                                                                                                         |\n|          | Larger rivers in wide valleys with low slopes and low elevations, with semi-intensive riparian corridor use due to agricultural activity.               |\n|          |                                                                                                                                                         |\n|          | -   above average values: `PC1`                                                                                                                         |\n|          |                                                                                                                                                         |\n|          | -   below average: `PC2`, `PC4`                                                                                                                         |\n+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------+\n| **3**    | **Small upstream rivers**                                                                                                                               |\n|          |                                                                                                                                                         |\n|          | Smaller and unforested riparian corridors in higher elevations and with more natural open areas and grasslands and less activity in the adjacent areas. |\n|          |                                                                                                                                                         |\n|          | -   below average values: `PC1`, `PC3`                                                                                                                  |\n+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------+\n| **4**    | **Forested medium-sized rivers**                                                                                                                        |\n|          |                                                                                                                                                         |\n|          | Large and forested riparian corridors in lower elevations with few grassland and natural open area.                                                     |\n|          |                                                                                                                                                         |\n|          | -   above average values: `PC3`                                                                                                                         |\n+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------+\n| **5**    | **Diverse medium-sized and large rivers**                                                                                                               |\n|          |                                                                                                                                                         |\n|          | Medium-sized and larger streams in lower elevations with different landuse patterns and active channel sizes.                                           |\n|          |                                                                                                                                                         |\n|          | -   above average values: `PC1`, `PC2`, `PC3`                                                                                                           |\n+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------+\n\n: Characteristics of clusters\n\n### Clusters on network map\n\n```{r mapping clusters}\n#| label: Mapping of clusters\n#| echo: false\n#| warning: false\n\ncluster_sf <- network_sf |>\n  dplyr::left_join(data_cleaned_pc, by = join_by(gid == fid)) |>\n  dplyr::select(cluster) |>\n  arrange(cluster)\n# \n# plot(cluster_sf, pal = cols, main = \"Network colored by cluster\")\n\n# in mapview:\nmapv_colors <- mapv_colors(cluster_sf, \"cluster\", cols)\nmapview(cluster_sf, zcol = \"cluster\", color = mapv_colors, lwd = 4)\n```\n\n### Cluster series Isère\n\n```{r cluster series isere}\n#| label: PCA series with cluster in background\n#| echo: false\n#| warning: false\n\n\n# plot PC1 and PC2 over length\nplot_pca <- function(data){\n  \n  p1 <- plot_pc(data, \"fid\", \"PC1\", \"cluster\", cols)\n  p2 <- plot_pc(data, \"fid\", \"PC2\", \"cluster\", cols)\n  p3 <- plot_pc(data, \"fid\", \"PC3\", \"cluster\", cols)\n  p4 <- plot_pc(data, \"fid\", \"PC4\", \"cluster\", cols)\n  plot <- ggpubr::ggarrange(p1, p2, p3, p4, ncol=1, nrow=4, \n                            common.legend = TRUE, legend=\"bottom\")\n  \n  return(plot)\n}\n\nplot_pca(data_cleaned_pc |> dplyr::filter(fid <= 9041 & fid >=7623))\n```\n:::\n\n## Hidden-Markov-Model\n\n::: panel-tabset\n### HMM-package\n\n3-state HMM applied to the cluster series of the Isère River. Modeling is done via the `HMM`-package, using the *Baum-Welch algorithm* to fit the model and the *Viterbi algorithm* to compute most probable path of states.\n\n```{r HMM}\n#| echo: false\n#| warning: false\nisere <- data_cleaned_pc |> dplyr::filter(fid <= 9041 & fid >=7623)\n\n# calculate initial cluster proportions\ncluster_proportions <- round(table(isere$cluster)/length(isere$cluster), 2) # |> as.vector()\n\n# initialize emission matrix, assigning to each state the probability to emit a certain cluster\nM_E=matrix(c(cluster_proportions[1]+0.05, cluster_proportions[1], cluster_proportions[1]-0.05,\n             cluster_proportions[2]-0.05, cluster_proportions[2], cluster_proportions[2]+0.05,\n             cluster_proportions[3], cluster_proportions[3], cluster_proportions[3],\n             cluster_proportions[4]-0.05, cluster_proportions[4], cluster_proportions[4]+0.05,\n             cluster_proportions[5]+0.05, cluster_proportions[5], cluster_proportions[5]-0.05),\n           nrow=3)\n# rownames(M_E)=c(\"A\",\"B\", \"c\")\n# colnames(M_E)=paste0(\"cluster\",1:5)\n# M_E\n\n# initialize transition matrix to set up probabilities of switching to next state\nM_T=matrix(c(.4,.3,.3,\n             .3,.4,.3,\n             .3,.3,.4),3)\n# rownames(M_T)=c(\"A\",\"B\", \"C\")\n# colnames(M_T)=c(\"A\",\"B\", \"C\")\n# M_T\n\n# initialize HMM\ninitial_HMM=HMM::initHMM(States=c(\"A\",\"B\", \"C\"),\n                    Symbols=(1:5),\n                    transProbs=M_T,\n                    emissionProbs=M_E)\n\n# fit HMM using Baum-Welch algorithm\nhmm_fit= HMM::baumWelch(initial_HMM,na.omit(isere$cluster),maxIterations=100)$hmm\n\n# set colors of states\ncolstates=c(\"A\" = \"#8338ec\", \"B\" = \"#83c5be\", \"C\" = \"#343a40\")\n\n# plot emission and transition probabilities via mosaic plots\nlayout(matrix(1:2,nrow=1))\npar(las=1)\nmosaicplot(hmm_fit$emissionProbs, main = \"Emission Probabilities\", col=cols)\nmosaicplot(hmm_fit$transProbs, main = \"Transition Probabilities\", col=colstates)\n\n# compute most probable path of states and add it to isere-dataset\nisere$HMM_state = as.factor(HMM::viterbi(hmm_fit,na.omit(isere$cluster)))\n\nplot_cluster_series <- plot_categ(data = isere, \"fid\", cat = \"cluster\", cols)\nplot_hmm_series <- plot_categ(data = isere, \"fid\", cat = \"HMM_state\", colors = colstates)\n\nggpubr::ggarrange(plot_cluster_series, plot_hmm_series, ncol = 1, nrow = 2, \n                  common.legend = F, legend=\"bottom\")\n\n```\n\n### depmixS4-package\n\nAllows for multivariate modelling of hidden markov chains. First tries below, comparison plot as following:\n\n1.  Cluster series on Isère\n\n2.  HMM as previously presented\n\n3.  depmix-model based on clusters\n\n4.  depmix-model based on direct values of the four first principal components\n\n```{r depmix clusters}\n#| echo: false\n#| warning: false\nrequire(depmixS4)\n\n# random number generator\nset.seed(1)\n\n# create model\nmod_clust <- depmixS4::depmix(\n  response = cluster~1, # cluster as response variable\n  data = isere, # dataset with response variable\n  nstates = 3, # number of states\n  trstart = runif(9), # random uniform distribution of initial transition matrix\n  family = multinomial() # setting response variables distribution family to multinomial for factors\n)\n\n# fit model\nfm_clust <- depmixS4::fit(\n  mod_clust, \n  emc = em.control(rand = FALSE)\n)\n\n# assign states to data\nisere$state_depmix <- depmixS4::posterior(fm_clust)$state\n```\n\n```{r depmix pcs}\n#| echo: false\n#| warning: false\n# random number generator\nset.seed(1)\n\n# create model\nmod_pc <- depmixS4::depmix(\n  list(PC1~1, PC2~1, PC3~1, PC4~1), # cluster as response variable\n  data = isere, # dataset with response variable\n  nstates = 3, # number of states\n  trstart = runif(9), # random uniform distribution of initial transition matrix\n  family = list(gaussian(), gaussian(), gaussian(), gaussian()) # setting response variables distribution family to multinomial for factors\n)\n\n# fit model\nfm_pc <- depmixS4::fit(\n  mod_pc, \n  emc = em.control(rand=FALSE)\n)\n\n# assign states to data\nisere$state_pcs_depmix <- depmixS4::posterior(fm_pc)$state\n```\n\n```{r plot all series together}\n#| echo: false\n#| warning: false\n\nisere <- isere |> mutate(state_depmix = as.factor(state_depmix), \n                         state_pcs_depmix = as.factor(state_pcs_depmix))\n\n# set colors of states\ncolstates_depmix <- c(\"1\" = \"#8338ec\", \"2\" = \"#83c5be\", \"3\" = \"#343a40\")\n\n# 1 - k-means clustering\nplot_cluster_series <- plot_categ(data = isere, \"fid\", cat = \"cluster\", cols)\n\n# 2 - HMM\nplot_hmm_series <- plot_categ(data = isere, \"fid\", cat = \"HMM_state\", colors = colstates)\n\n# 3 - depmix clusters\nplot_depmix_cluster_series <- plot_categ(data = isere, \"fid\", cat = \"state_depmix\", colors = colstates_depmix)\n\n# 4 - depmix PCs\nplot_depmix_pc_series <- plot_categ(data = isere, \"fid\", cat = \"state_pcs_depmix\", colors = colstates_depmix)\n\n\nggpubr::ggarrange(plot_cluster_series, plot_hmm_series, \n                  plot_depmix_cluster_series, plot_depmix_pc_series,\n                  ncol = 1, nrow = 4, \n                  common.legend = F, legend = \"none\")\n\n```\n:::\n\n## Next steps\n\n-   remove \"holes\" in series-representation to fit longitudanal extent of stream segments well\n\n-   use the `usethis`-package to hide password of database access\n\n-   advance with dependent mixture / HMM model :\n\n    -   multivariate modelling with [depmixS4-package](https://cran.r-project.org/web/packages/depmixS4/vignettes/depmixS4.pdf \"https://cran.r-project.org/web/packages/depmixS4/vignettes/depmixS4.pdf\")\n\n    -   Can river network be modelled through a geographic tree structure and not a unidirectional chain, e.g. as in [Jiang et al. (2019)](https://ieeexplore.ieee.org/document/8769900/ \"https://ieeexplore.ieee.org/document/8769900/\") ?\n\n-   start learning R-Shiny development (e.g. with Lise's course and ThinkR material)","srcMarkdownNoYaml":"\n\n```{r set-up}\n#| echo: false\n#| output: false\nlibrary(tidyverse)\nrequire(RPostgreSQL)\nrequire(DataExplorer) # general dataset exploration\nlibrary(factoextra) # for pca-biplots \nlibrary(sf) # geospatial manipulations\nlibrary(mapview) # geospatial visualisation\nsource(\"src/f_explo.R\")\nsource(\"src/f_database.R\")\n\n# load network metrics\nnetwork_metrics <- load_network_metrics()\n\n# create network sf-file\nnetwork_sf <- load_metrics_sf(network_metrics)\n\n# create datasets\ndata_all <- network_metrics|> dplyr::select(\"strahler\":\"sum_area\")\ndata_discrete <- network_metrics|> dplyr::select(\"strahler\":\"built_environment\", \"sum_area\")\ndata_relative <- network_metrics|> dplyr::select(\"fid\", \"strahler\":\"floodplain_slope\", \"water_channel_pc\":\"sum_area\")\n```\n\n## Points\n\n-   Dataset overview\n\n-   Variable cleaning\n\n-   Principal Component Analysis\n\n-   K-means Clustering\n\n-   Hidden-Markov-Modeling\n\n-   Next steps\n\n## Dataset overview\n\n::: panel-tabset\n### Map\n\n```{r map}\n#| echo: false\n# out-width: \"50%\"\n\n# plot network \nplot(network_sf |> dplyr::select())\n# mapview::mapview(network_sf |> dplyr::select(strahler))\n```\n\n### Variables\n\n```{r variable overview}\n# plot histograms for all variables\nDataExplorer::plot_histogram(data_all, nrow = 4)\n```\n\n### Correlation: real Vars\n\n```{r corr discrete}\n#| echo: false\n#| warning: false\n\nDataExplorer::plot_correlation(data_discrete, title = \"Correlation Matrix of discrete variables\")\n```\n\n### Correlation: Norm. Vars\n\n```{r corr normalized}\n#| echo: false\n#| warning: false\n\nDataExplorer::plot_correlation(data_relative |> dplyr::select(!fid), title = \"Correlation Matrix of relative variables\")\n```\n\nDataset containing only the normalized variables for the land use and lateral continuity (area normalized to the valley bottom area)\n:::\n\n## Variable cleaning\n\n::: panel-tabset\n### Description\n\nBased on high values of correlation and similarities in the PCA, the following variables are removed:\n\n-   `floodplain_slope` as it is represented well by `talweg_slope`\n-   `gravel_bars_pc` as it is represented well in `active_channel_pc`\n-   `water_channel_width` as it is represented well in `active_channel_width`\n-   `valley_bottom_width` by `sum_area`\n-   `semi_natural_pc` as it is falsely calculated and only represents `grassland_pc`\n-   `reversible_pc` as as it is falsely calculated and only represents `grassland_pc` and `crops_pc`\n-   `infrastructures_pc`, `dense_urban_pc`, and `diffuse_urban_pc` are well represented by `built_environment_pc`\n-   `natural_corridor_width` represented well by `connected_corridor_width`\n\n### Cleaned dataset\n\n```{r corr cleaned}\n#| echo: false\n#| warning: false\n\nvariables_remove <- c(\"floodplain_slope\", \"gravel_bars_pc\", \"water_channel_width\",\n                      \"valley_bottom_width\", \"semi_natural_pc\", \"infrastructures_pc\",\n                      \"dense_urban_pc\", \"diffuse_urban_pc\", \"natural_corridor_width\", \"reversible_pc\")\n\ndata_cleaned_pc <- data_relative |> dplyr::select(!variables_remove)\nDataExplorer::plot_correlation(data_cleaned_pc |> dplyr::select(!fid), title = \"Correlation Matrix of cleaned dataset\")\n```\n:::\n\n## PCA\n\n::: panel-tabset\n### cleaned dataset\n\n```{r}\n#| echo: false\n#| warning: false\n\nDataExplorer::plot_prcomp(data_cleaned_pc |> dplyr::select(!fid), variance_cap = 0.9, nrow = 2L, ncol = 2L, title = \"PCA of cleaned variables\")\n\n# Biplots generation\npca_cleaned <- prcomp(data_cleaned_pc |> dplyr::select(!fid), \n                      scale = TRUE)\n\nfactoextra::fviz_pca_ind(pca_cleaned,\n                         label = \"none\",\n                         col.ind = \"cos2\",\n                         alpha.ind = 0.7,\n                         gradient.cols = c(\"#03045e\",\"#caf0f8\",\"#d62828\"),\n                         title = \"PCA-Biplot 1-2: Quality of representation of individuals\")\n\nfactoextra::fviz_pca_var(pca_cleaned,     \n                         label = \"var\",\n                         select.var = list(contrib = 10),\n                         repel = T,\n                         title = \"PCA-Biplot 1-2: contribution of first 10 variables\")\n\nfactoextra::fviz_pca_ind(pca_cleaned,\n                         axes = c(1,3),\n                         label = \"none\",\n                         col.ind = \"cos2\",\n                         alpha.ind = 0.7,\n                         gradient.cols = c(\"#03045e\",\"#caf0f8\",\"#d62828\"),\n                         title = \"PCA-Biplot 1-3: Quality of representation of individuals\")\n\nfactoextra::fviz_pca_var(pca_cleaned,\n                         axes = c(1,3),\n                         label = \"var\",\n                         select.var = list(contrib = 10),\n                         repel = T,\n                         title = \"PCA-Biplot 1-3: contribution of first 10 variables\")\n\nfactoextra::fviz_pca_ind(pca_cleaned,\n                         axes = c(1,4),\n                         label = \"none\",\n                         col.ind = \"cos2\",\n                         alpha.ind = 0.7,\n                         gradient.cols = c(\"#03045e\",\"#caf0f8\",\"#d62828\"),\n                         title = \"PCA-Biplot 1-4: Quality of representation of individuals\")\n\nfactoextra::fviz_pca_var(pca_cleaned,\n                         axes = c(1,4),\n                         label = \"var\",\n                         select.var = list(contrib = 10),\n                         repel = T,\n                         title = \"PCA-Biplot 1-4: contribution of first 10 variables\")\n```\n\nAccording to the results, the first four principal components are sufficient to represent 64.5 % of the variability of the data set. In the following, each of these PCs is analysed according to the individual association of the variables to them in order to facilitate interpretation.\n\n+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| PC      | Description                                                                                                                                                                                         |\n+=========+=====================================================================================================================================================================================================+\n| **PC1** | ***Positive values** indicate* *large rivers in wide valleys with low slopes and low elevations, with comparably small riparian corridor and diverse anthropogenic activity in the adjacent areas.* |\n|         |                                                                                                                                                                                                     |\n|         | ***Negative values** indicate smaller rivers in narrow valleys with higher slopes and elevations, with a greater relative area for the riparian corridor and less activity in the adjacent areas.*  |\n|         |                                                                                                                                                                                                     |\n|         | -   positive variable importance: `sum_area`, `strahler`, `connected_corridor_width`, `active_channel_width`, `crops_pc`, `disconnected_pc`                                                         |\n|         |                                                                                                                                                                                                     |\n|         | -   negative variable importance:`talweg_slope`, `talweg_elevation_min`, `riparian_corridor_pc`                                                                                                     |\n+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| **PC2** | ***Positive values** indicate rather narrow valleys in which most of the space is taken by the water channel with few space for the connected corridor and crops.*                                  |\n|         |                                                                                                                                                                                                     |\n|         | ***Negative values** indicate wide valleys with smaller channel width to valley width ratios and larger shares of connected corridor and crops.*                                                    |\n|         |                                                                                                                                                                                                     |\n|         | -   positive VI: `water_channel_pc`, `idx_confinement`, `active_channel_width`                                                                                                                      |\n|         |                                                                                                                                                                                                     |\n|         | -   negative VI: `sum_area`, `crops_pc`, `disconnected_pc`, `connected_corridor_width`                                                                                                              |\n+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| **PC3** | ***Positive values** indicate comparably large and forested riparian corridors in lower elevations with few grassland and natural open area.*                                                       |\n|         |                                                                                                                                                                                                     |\n|         | ***Negative values** thus indicate comparably small and unforested riparian corridors in higher elevations and with more natural open areas and grasslands.*                                        |\n|         |                                                                                                                                                                                                     |\n|         | -   positive VI: `riparian_corridor_pc`, `forest_pc`                                                                                                                                                |\n|         |                                                                                                                                                                                                     |\n|         | -   negative VI: `talweg_elevation_min`, `natural_open_pc`, `grassland_pc`                                                                                                                          |\n+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| **PC4** | ***Positive values** indicate rather smaller, confined streams with a strong presence of anthropogenic infrastructure.*                                                                             |\n|         |                                                                                                                                                                                                     |\n|         | ***Negative values** thus indicate comparably larger rivers with more space for the active channel and no presence of built/anthropogenic infrastructure in the adjacent zones.*                    |\n|         |                                                                                                                                                                                                     |\n|         | -   positive VI: `riparian_corridor_pc`, `forest_pc`                                                                                                                                                |\n|         |                                                                                                                                                                                                     |\n|         | -   negative VI: `talweg_elevation_min`, `natural_open_pc`, `grassland_pc`, `idx_confinement`, `crops_pc`, `active_channel_width`, `connected_corridor_width`                                       |\n+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n\n: Characteristics of principal components\n\n### whole dataset\n\n```{r PCA all variables}\n#| echo: false\n#| warning: false\n\nDataExplorer::plot_prcomp(data_all, variance_cap = 0.7, nrow = 1L, ncol = 2L, title = \"PCA of discrete variables\")\n\n# Biplots generation\npca_all <- prcomp(data_all, \n                  scale = TRUE)\n\nfactoextra::fviz_pca_ind(pca_all,\n                         label = \"none\",\n                         col.ind = \"cos2\",\n                         alpha.ind = 0.7,\n                         gradient.cols = c(\"#03045e\",\"#caf0f8\",\"#d62828\"),\n                         title = \"PCA-Biplot 1-2: Quality of representation of individuals\")\n\nfactoextra::fviz_pca_var(pca_all,     \n                         label = \"var\",\n                         select.var = list(contrib = 10),\n                         repel = T,\n                         title = \"PCA-Biplot 1-2: contribution of first 10 variables\")\n```\n\n### only real vars\n\n```{r PCA discrete variables}\n#| echo: false\n#| warning: false\n\nDataExplorer::plot_prcomp(data_discrete, variance_cap = 0.9, nrow = 2L, ncol = 2L, title = \"PCA of discrete variables\")\n\n# Biplots generation\npca_dis <- prcomp(data_discrete, \n                  scale = TRUE)\n\nfactoextra::fviz_pca_ind(pca_dis,\n                         label = \"none\",\n                         col.ind = \"cos2\",\n                         alpha.ind = 0.7,\n                         gradient.cols = c(\"#03045e\",\"#caf0f8\",\"#d62828\"),\n                         title = \"PCA-Biplot 1-2: Quality of representation of individuals\")\n\nfactoextra::fviz_pca_var(pca_dis,     \n                         label = \"var\",\n                         select.var = list(contrib = 10),\n                         repel = T,\n                         title = \"PCA-Biplot 1-2: contribution of first 10 variables\")\n```\n\n### only norm. vars\n\n```{r}\n#| label: PCA relative variables\n#| echo: false\n#| warning: false\n\nDataExplorer::plot_prcomp(data_relative |> dplyr::select(!fid), variance_cap = 0.9, nrow = 2L, ncol = 2L, title = \"PCA of relative variables\")\n\n# Biplots generation\npca_rel <- prcomp(data_relative |> dplyr::select(!fid), \n                  scale = TRUE)\n\nfactoextra::fviz_pca_ind(pca_rel,\n                         label = \"none\",\n                         col.ind = \"cos2\",\n                         alpha.ind = 0.7,\n                         gradient.cols = c(\"#03045e\",\"#caf0f8\",\"#d62828\"),\n                         title = \"PCA-Biplot 1-2: Quality of representation of individuals\")\n\nfactoextra::fviz_pca_var(pca_rel,     \n                         label = \"var\",\n                         select.var = list(contrib = 10),\n                         repel = T,\n                         title = \"PCA-Biplot 1-2: contribution of first 10 variables\")\n```\n:::\n\n## K-means Clustering\n\n::: panel-tabset\n### Method\n\nK-means is a clustering method that generates clusters based on the search for centers of gravity to which the mean distance from the associated data points is minimized. In order to apply this method, the number of clusters must first be determined. For this purpose, 24 different indices were evaluated using the `NBClust`-package. Among all indices:\\\n\n-   4 proposed 2 as the best number of clusters\n-   5 proposed 3 as the best number of clusters\n-   2 proposed 4 as the best number of clusters\n-   10 proposed 5 as the best number of clusters\n-   1 proposed 8 as the best number of clusters\n-   1 proposed 9 as the best number of clusters\n-   1 proposed 10 as the best number of clusters\n\nAccording to the majority rule, the best number of clusters is 5.\n\n### Results\n\n```{r clustering}\n#| label: clustering\n#| echo: false\n#| warning: false\n\ndata_cleaned_pc$PC1 <- pca_cleaned$x[,\"PC1\"]\ndata_cleaned_pc$PC2 <- pca_cleaned$x[,\"PC2\"]\ndata_cleaned_pc$PC3 <- pca_cleaned$x[,\"PC3\"]\ndata_cleaned_pc$PC4 <- pca_cleaned$x[,\"PC4\"]\n\n\n# # automatic clustering ----------------------------------------------------\n# automatic_clustering <- function(data){\n#   library(NbClust)\n# \n#   set.seed(123)\n# \n#   data_clust <- data |>\n#     scale() |>\n#     NbClust(distance = \"euclidean\",\n#             min.nc = 2,\n#             max.nc = 10,\n#             method = \"kmeans\",\n#             index = \"all\")\n# \n#   return(data_clust)\n# }\n# \n# # apply automatic clustering to identify optimal number of clusters\n# auto_clust <- automatic_clustering(data = data_cleaned_pc |> dplyr::select(PC1:PC4))\n\n# OPTIMAL NUMBER OF CLUSTERS: 4\nno_clusters <- 5\n\n\n# Apply clusters to data --------------------------------------------------\n\n# create cluster file\ndata_clust <- eclust(data_cleaned_pc |> select(PC1:PC4),\n                     FUNcluster = \"kmeans\",\n                     k = no_clusters,\n                     graph = FALSE)\n\n\n# Assign the optimal partition to original dataset\ndata_cleaned_pc$cluster <- as.factor(data_clust$cluster)\n\n\n# show cluster plot\nfviz_cluster(data_clust,\n             axes = c(1,2),\n             palette = cols,\n             ggtheme = theme_minimal(),\n             main = \"Bi-Plot Cluster on C 1&2\",\n             geom = \"point\"\n)\n\nfviz_cluster(data_clust,\n             axes = c(1,3),\n             palette = cols,\n             ggtheme = theme_minimal(),\n             main = \"Bi-Plot Cluster on C 1&3\",\n             geom = \"point\"\n)\n\nfviz_cluster(data_clust,\n             axes = c(1,4),\n             palette = cols,\n             ggtheme = theme_minimal(),\n             main = \"Bi-Plot Cluster on C 1&4\",\n             geom = \"point\"\n)\n\n\n# recreate biplot of PC1-PC2, colored by clusters \n# pca_cleaned_grouped <- FactoMineR::PCA(data_cleaned_pc |> dplyr::select(!fid), \n#                 scale.unit = TRUE,\n#                 quali.sup = c(\"cluster\"), \n#                 graph = FALSE)\n# \n# factoextra::fviz_pca_ind(pca_cleaned_grouped,\n#                          label = \"none\",\n#                          habillage = \"cluster\",\n#                          col.ind = \"cluster\",\n#                          alpha.ind = 0.7,\n#                          palette = cols,\n#                          title = \"PCA-Biplot 1-2: Quality of representation of individuals\")\n\n```\n\n```{r boxplots clusters}\n#| label: boxplots clusters\n#| echo: false\n#| warning: false\n\nplot_jitterboxplots_pca <- function(data){\n  \n  p1 <- ggpubr::ggboxplot(data, x = \"cluster\", y = \"PC1\", add = \"jitter\", color = \"cluster\", palette = cols, ggtheme = theme_minimal()) \n  p2 <- ggpubr::ggboxplot(data, x = \"cluster\", y = \"PC2\", add = \"jitter\", color = \"cluster\", palette = cols, ggtheme = theme_minimal()) \n  p3 <- ggpubr::ggboxplot(data, x = \"cluster\", y = \"PC3\", add = \"jitter\", color = \"cluster\", palette = cols, ggtheme = theme_minimal()) \n  p4 <- ggpubr::ggboxplot(data, x = \"cluster\", y = \"PC4\", add = \"jitter\", color = \"cluster\", palette = cols, ggtheme = theme_minimal()) \n  \n  plot <- ggpubr::ggarrange(p1, p2, p3, p4, ncol=2, nrow=2, legend=\"none\")\n  \n  return(plot)\n}\n\nplot_jitterboxplots_pca(data_cleaned_pc |> dplyr::filter(fid <= 9041 & fid >=7623))\n\n```\n\n### Cluster characteristics\n\nBased on the data-distributions, the main characteristics of the clusters are summarized in the following table:\n\n+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Cluster  | Derived characteristics                                                                                                                                 |\n+==========+=========================================================================================================================================================+\n| **1**    | **Rivers confined by anthropogenized floodplain**                                                                                                       |\n|          |                                                                                                                                                         |\n|          | Rather confined, lower elevation rivers with altered riparian zone including diverse usages such as urban and agricultural infrastructure.              |\n|          |                                                                                                                                                         |\n|          | -   above average values: `PC4`, `PC1`                                                                                                                  |\n+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------+\n| **2**    | **Larger rivers with agricultural landscape**                                                                                                           |\n|          |                                                                                                                                                         |\n|          | Larger rivers in wide valleys with low slopes and low elevations, with semi-intensive riparian corridor use due to agricultural activity.               |\n|          |                                                                                                                                                         |\n|          | -   above average values: `PC1`                                                                                                                         |\n|          |                                                                                                                                                         |\n|          | -   below average: `PC2`, `PC4`                                                                                                                         |\n+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------+\n| **3**    | **Small upstream rivers**                                                                                                                               |\n|          |                                                                                                                                                         |\n|          | Smaller and unforested riparian corridors in higher elevations and with more natural open areas and grasslands and less activity in the adjacent areas. |\n|          |                                                                                                                                                         |\n|          | -   below average values: `PC1`, `PC3`                                                                                                                  |\n+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------+\n| **4**    | **Forested medium-sized rivers**                                                                                                                        |\n|          |                                                                                                                                                         |\n|          | Large and forested riparian corridors in lower elevations with few grassland and natural open area.                                                     |\n|          |                                                                                                                                                         |\n|          | -   above average values: `PC3`                                                                                                                         |\n+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------+\n| **5**    | **Diverse medium-sized and large rivers**                                                                                                               |\n|          |                                                                                                                                                         |\n|          | Medium-sized and larger streams in lower elevations with different landuse patterns and active channel sizes.                                           |\n|          |                                                                                                                                                         |\n|          | -   above average values: `PC1`, `PC2`, `PC3`                                                                                                           |\n+----------+---------------------------------------------------------------------------------------------------------------------------------------------------------+\n\n: Characteristics of clusters\n\n### Clusters on network map\n\n```{r mapping clusters}\n#| label: Mapping of clusters\n#| echo: false\n#| warning: false\n\ncluster_sf <- network_sf |>\n  dplyr::left_join(data_cleaned_pc, by = join_by(gid == fid)) |>\n  dplyr::select(cluster) |>\n  arrange(cluster)\n# \n# plot(cluster_sf, pal = cols, main = \"Network colored by cluster\")\n\n# in mapview:\nmapv_colors <- mapv_colors(cluster_sf, \"cluster\", cols)\nmapview(cluster_sf, zcol = \"cluster\", color = mapv_colors, lwd = 4)\n```\n\n### Cluster series Isère\n\n```{r cluster series isere}\n#| label: PCA series with cluster in background\n#| echo: false\n#| warning: false\n\n\n# plot PC1 and PC2 over length\nplot_pca <- function(data){\n  \n  p1 <- plot_pc(data, \"fid\", \"PC1\", \"cluster\", cols)\n  p2 <- plot_pc(data, \"fid\", \"PC2\", \"cluster\", cols)\n  p3 <- plot_pc(data, \"fid\", \"PC3\", \"cluster\", cols)\n  p4 <- plot_pc(data, \"fid\", \"PC4\", \"cluster\", cols)\n  plot <- ggpubr::ggarrange(p1, p2, p3, p4, ncol=1, nrow=4, \n                            common.legend = TRUE, legend=\"bottom\")\n  \n  return(plot)\n}\n\nplot_pca(data_cleaned_pc |> dplyr::filter(fid <= 9041 & fid >=7623))\n```\n:::\n\n## Hidden-Markov-Model\n\n::: panel-tabset\n### HMM-package\n\n3-state HMM applied to the cluster series of the Isère River. Modeling is done via the `HMM`-package, using the *Baum-Welch algorithm* to fit the model and the *Viterbi algorithm* to compute most probable path of states.\n\n```{r HMM}\n#| echo: false\n#| warning: false\nisere <- data_cleaned_pc |> dplyr::filter(fid <= 9041 & fid >=7623)\n\n# calculate initial cluster proportions\ncluster_proportions <- round(table(isere$cluster)/length(isere$cluster), 2) # |> as.vector()\n\n# initialize emission matrix, assigning to each state the probability to emit a certain cluster\nM_E=matrix(c(cluster_proportions[1]+0.05, cluster_proportions[1], cluster_proportions[1]-0.05,\n             cluster_proportions[2]-0.05, cluster_proportions[2], cluster_proportions[2]+0.05,\n             cluster_proportions[3], cluster_proportions[3], cluster_proportions[3],\n             cluster_proportions[4]-0.05, cluster_proportions[4], cluster_proportions[4]+0.05,\n             cluster_proportions[5]+0.05, cluster_proportions[5], cluster_proportions[5]-0.05),\n           nrow=3)\n# rownames(M_E)=c(\"A\",\"B\", \"c\")\n# colnames(M_E)=paste0(\"cluster\",1:5)\n# M_E\n\n# initialize transition matrix to set up probabilities of switching to next state\nM_T=matrix(c(.4,.3,.3,\n             .3,.4,.3,\n             .3,.3,.4),3)\n# rownames(M_T)=c(\"A\",\"B\", \"C\")\n# colnames(M_T)=c(\"A\",\"B\", \"C\")\n# M_T\n\n# initialize HMM\ninitial_HMM=HMM::initHMM(States=c(\"A\",\"B\", \"C\"),\n                    Symbols=(1:5),\n                    transProbs=M_T,\n                    emissionProbs=M_E)\n\n# fit HMM using Baum-Welch algorithm\nhmm_fit= HMM::baumWelch(initial_HMM,na.omit(isere$cluster),maxIterations=100)$hmm\n\n# set colors of states\ncolstates=c(\"A\" = \"#8338ec\", \"B\" = \"#83c5be\", \"C\" = \"#343a40\")\n\n# plot emission and transition probabilities via mosaic plots\nlayout(matrix(1:2,nrow=1))\npar(las=1)\nmosaicplot(hmm_fit$emissionProbs, main = \"Emission Probabilities\", col=cols)\nmosaicplot(hmm_fit$transProbs, main = \"Transition Probabilities\", col=colstates)\n\n# compute most probable path of states and add it to isere-dataset\nisere$HMM_state = as.factor(HMM::viterbi(hmm_fit,na.omit(isere$cluster)))\n\nplot_cluster_series <- plot_categ(data = isere, \"fid\", cat = \"cluster\", cols)\nplot_hmm_series <- plot_categ(data = isere, \"fid\", cat = \"HMM_state\", colors = colstates)\n\nggpubr::ggarrange(plot_cluster_series, plot_hmm_series, ncol = 1, nrow = 2, \n                  common.legend = F, legend=\"bottom\")\n\n```\n\n### depmixS4-package\n\nAllows for multivariate modelling of hidden markov chains. First tries below, comparison plot as following:\n\n1.  Cluster series on Isère\n\n2.  HMM as previously presented\n\n3.  depmix-model based on clusters\n\n4.  depmix-model based on direct values of the four first principal components\n\n```{r depmix clusters}\n#| echo: false\n#| warning: false\nrequire(depmixS4)\n\n# random number generator\nset.seed(1)\n\n# create model\nmod_clust <- depmixS4::depmix(\n  response = cluster~1, # cluster as response variable\n  data = isere, # dataset with response variable\n  nstates = 3, # number of states\n  trstart = runif(9), # random uniform distribution of initial transition matrix\n  family = multinomial() # setting response variables distribution family to multinomial for factors\n)\n\n# fit model\nfm_clust <- depmixS4::fit(\n  mod_clust, \n  emc = em.control(rand = FALSE)\n)\n\n# assign states to data\nisere$state_depmix <- depmixS4::posterior(fm_clust)$state\n```\n\n```{r depmix pcs}\n#| echo: false\n#| warning: false\n# random number generator\nset.seed(1)\n\n# create model\nmod_pc <- depmixS4::depmix(\n  list(PC1~1, PC2~1, PC3~1, PC4~1), # cluster as response variable\n  data = isere, # dataset with response variable\n  nstates = 3, # number of states\n  trstart = runif(9), # random uniform distribution of initial transition matrix\n  family = list(gaussian(), gaussian(), gaussian(), gaussian()) # setting response variables distribution family to multinomial for factors\n)\n\n# fit model\nfm_pc <- depmixS4::fit(\n  mod_pc, \n  emc = em.control(rand=FALSE)\n)\n\n# assign states to data\nisere$state_pcs_depmix <- depmixS4::posterior(fm_pc)$state\n```\n\n```{r plot all series together}\n#| echo: false\n#| warning: false\n\nisere <- isere |> mutate(state_depmix = as.factor(state_depmix), \n                         state_pcs_depmix = as.factor(state_pcs_depmix))\n\n# set colors of states\ncolstates_depmix <- c(\"1\" = \"#8338ec\", \"2\" = \"#83c5be\", \"3\" = \"#343a40\")\n\n# 1 - k-means clustering\nplot_cluster_series <- plot_categ(data = isere, \"fid\", cat = \"cluster\", cols)\n\n# 2 - HMM\nplot_hmm_series <- plot_categ(data = isere, \"fid\", cat = \"HMM_state\", colors = colstates)\n\n# 3 - depmix clusters\nplot_depmix_cluster_series <- plot_categ(data = isere, \"fid\", cat = \"state_depmix\", colors = colstates_depmix)\n\n# 4 - depmix PCs\nplot_depmix_pc_series <- plot_categ(data = isere, \"fid\", cat = \"state_pcs_depmix\", colors = colstates_depmix)\n\n\nggpubr::ggarrange(plot_cluster_series, plot_hmm_series, \n                  plot_depmix_cluster_series, plot_depmix_pc_series,\n                  ncol = 1, nrow = 4, \n                  common.legend = F, legend = \"none\")\n\n```\n:::\n\n## Next steps\n\n-   remove \"holes\" in series-representation to fit longitudanal extent of stream segments well\n\n-   use the `usethis`-package to hide password of database access\n\n-   advance with dependent mixture / HMM model :\n\n    -   multivariate modelling with [depmixS4-package](https://cran.r-project.org/web/packages/depmixS4/vignettes/depmixS4.pdf \"https://cran.r-project.org/web/packages/depmixS4/vignettes/depmixS4.pdf\")\n\n    -   Can river network be modelled through a geographic tree structure and not a unidirectional chain, e.g. as in [Jiang et al. (2019)](https://ieeexplore.ieee.org/document/8769900/ \"https://ieeexplore.ieee.org/document/8769900/\") ?\n\n-   start learning R-Shiny development (e.g. with Lise's course and ThinkR material)"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"24-04-22_progress_report_meeting.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.5.42","editor":"visual","title":"Mapd'O Network metrics exploration","subtitle":"Progress meeting 22.04.2024","author":"Leo Helling","title-slide-attributes":{"data-background-color":"#023e8a"}},"extensions":{"book":{"multiFile":true}}}},"projectFormats":[]}